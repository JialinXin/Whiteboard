<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4"
    crossorigin="anonymous">

  <title>Whiteboard</title>
  <style>
    /*
    .navbar {
      padding: 0;
    }*/

    .navbar-brand {
      padding: 0;
      margin: 0;
    }

    .nav-logo-img {
      width: 50px;
    }

    .disconnected {
      -webkit-filter: grayscale(100%); /* Safari 6.0 - 9.0 */
      filter: grayscale(100%);
    }

    .container-fluid {
      min-height: 100%;
      height: 100%;
      padding: 0;
    }

    html,
    body {
      height: 100%;
    }

    #whiteboard {
      width: 100%;
      height: 100%;
      min-height: 100%;
      display: block;
    }

    svg {
      display: block;
    }

    .toolbox {
      width: 7rem;
      height: 1.5rem;
      display: inline-block;
      vertical-align: middle;
      border-radius: 0.3rem;
      border: 1px solid black;
    }

    .selected {
      width: 4rem;
      border: 1px solid white;
    }

    .penbox {
      background-color: white;
    }
  </style>
</head>

<body>
  <header>
    <nav id="app" class="navbar navbar-expand-sm bg-dark fixed-top navbar-dark">
      <a class="navbar-brand " href="#">
        <img id="logo" src="images/signalr-logo.png" alt="logo" class="nav-logo-img">
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
        aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="clearScreen(); return false;">Clear</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              {{ tool }}
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a v-for="t in tools" v-bind:class="{ active: t === tool, 'dropdown-item': true }" v-on:click.prevent="tool = t" href="#">
                {{ t }}
              </a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              <span class="toolbox selected" v-bind:style="{ 'background-color': color }"></span>
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a v-for="c in colors" v-bind:class="{ active: c === color, 'dropdown-item': true }" v-on:click.prevent="color = c" href="#">
                <span class="toolbox" v-bind:style="{ 'background-color': c }"></span>
              </a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              <svg class="toolbox selected penbox">
                <line x1="0" y1="11" x2="61" y2="11" v-bind:stroke="color" v-bind:stroke-width="width" />
              </svg>
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a v-for="w in widths" v-bind:class="{ active: w === width, 'dropdown-item': true }" v-on:click.prevent="width = w" href="#">
                <svg class="toolbox penbox">
                  <line x1="0" y1="11" x2="111" y2="11" v-bind:stroke="color" v-bind:stroke-width="w" />
                </svg>
              </a>
            </div>
          </li>
        </ul>
      </div>
    </nav>
  </header>
  <div id="main" class="container-fluid fill">
    <div id="whiteboard"></div>
  </div>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.0.0/dist/browser/signalr.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.5/svg.min.js"></script>
  <script>
    function connect(url, connected, disconnected) {
      var connectWithRetry = c => c.start().then(() => connected(c)).catch(error => {
        console.log('Failed to start SignalR connection: ' + error.message);
        setTimeout(() => connectWithRetry(c), 5000);
      });

      // create connection
      var c = new signalR.HubConnectionBuilder().withUrl(url).build();

      // auto reconnect when connection is closed
      c.onclose(() => {
        disconnected(c);
        console.log('Disconnected, try to reconnect.');
        connectWithRetry(c);
      });

      connectWithRetry(c);
      return c;
    }

    function onConnect(c) {
      $('#logo').removeClass('disconnected');
      clearScreen(true);
    }

    function onDisconnect(c) {
      shapes = null;
      $('#logo').addClass('disconnected');
    }

    function generateId() {
      return Math.floor((1 + Math.random()) * 0x100000000).toString(16).substring(1);
    }

    function clearScreen(skipBroadcast) {
      shapes = {};
      whiteboard.clear();
      if (!skipBroadcast) connection.send('clear');
    }

    function initUI() {
      var id, data;
      var timestamp = 0;
      var broadcast = (force) => {
        var newTimestamp = new Date().getTime();
        if (!force && newTimestamp - timestamp < 200) return;
        connection.send('updateShape', id, { kind: options.tool, color: options.color, width: options.width, data: data });
        timestamp = newTimestamp;
      };
      $('#whiteboard').on('mousedown', e => {
        if (!shapes) return;
        var tool = tools[options.tool];
        id = generateId();
        data = tool.start(e.offsetX, e.offsetY);
        shapes[id] = tool.draw(whiteboard, options.color, options.width, data);
        broadcast(true);
      }).on('mouseup', e => {
        if (!shapes) return;
        if (id) {
          var tool = tools[options.tool];
          tool.move(e.offsetX, e.offsetY, data);
          tool.update(shapes[id], data);
          broadcast(true);
          id = data = null;
        }
      }).on('mousemove', e => {
        if (!shapes) return;
        if (id) {
          var tool = tools[options.tool];
          tool.move(e.offsetX, e.offsetY, data);
          tool.update(shapes[id], data);
          broadcast();
        }
      });
    }

    var shapes;
    var whiteboard = SVG('whiteboard');
    var connection = connect('/draw', onConnect, onDisconnect);

    var draw = (f, c, w) => f.fill('none').stroke({ color: c, width: w, linecap: 'round' });

    var tools = {
      polyline: {
        start: (x, y) => [x, y],
        move: (x, y, d) => d.push(x, y),
        draw: (b, c, w, d) => draw(b.polyline(d), c, w),
        update: (e, d) => e.plot(d)
      },
      line: {
        start: (x, y) => [x, y, x, y],
        move: (x, y, d) => { d[2] = x; d[3] = y; },
        draw: (b, c, w, d) => draw(b.line(d), c, w),
        update: (e, d) => e.plot(d)
      },
      rect: {
        start: (x, y) => [x, y, x, y],
        move: (x, y, d) => { d[2] = x; d[3] = y; },
        draw: (b, c, w, d) => draw(b.rect(Math.abs(d[2] - d[0]), Math.abs(d[3] - d[1])).move(Math.min(d[0], d[2]), Math.min(d[1], d[3])), c, w),
        update: (e, d) => e.x(Math.min(d[2], d[0])).y(Math.min(d[1], d[3])).size(Math.abs(d[2] - d[0]), Math.abs(d[3] - d[1]))
      },
      circle: {
        start: (x, y) => [x, y, 0],
        move: (x, y, d) => d[2] = Math.sqrt((d[0] - x) * (d[0] - x) + (d[1] - y) * (d[1] - y)),
        draw: (b, c, w, d) => draw(b.circle(d[2] * 2).cx(d[0]).cy(d[1]), c, w),
        update: (e, d) => e.radius(d[2])
      },
      ellipse: {
        start: (x, y) => [x, y, x, y],
        move: (x, y, d) => { d[2] = x; d[3] = y; },
        draw: (b, c, w, d) => draw(b.ellipse(Math.abs(d[2] - d[0]), Math.abs(d[3] - d[1])).cx((d[0] + d[2]) / 2).cy((d[1] + d[3]) / 2), c, w),
        update: (e, d) => e.cx((d[0] + d[2]) / 2).cy((d[1] + d[3]) / 2).radius(Math.abs(d[2] - d[0]) / 2, Math.abs(d[3] - d[1]) / 2)
      }
    };

    // setup callbacks
    connection.on('clear', () => clearScreen(true));
    connection.on('shapeUpdated', (i, s) => {
      if (shapes[i]) tools[s.kind].update(shapes[i], s.data);
      else shapes[i] = tools[s.kind].draw(whiteboard, s.color, s.width, s.data);
    });

    // init UI
    var options = {
      tool: 'polyline',
      color: 'black',
      width: 1,
      tools: Object.keys(tools),
      colors: ['black', 'grey', 'darkred', 'red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'purple'],
      widths: [1, 2, 4, 8]
    };
    var app = new Vue({
      el: '#app',
      data: options
    });
    initUI();
  </script>
</body>

</html>